<project xmlns:ivy="antlib:org.apache.ivy.ant" name="common-build-infrastructure">
	<target name="clean" depends="clean-output, clean-libraries"/>

	<target name="clean-libraries">
		<delete dir="${libraries.dir}" />
	</target>	

	<target name="clean-output">
		<delete dir="${output.dir}" />
	</target>

	<target name="retrieve" depends="clean">
		<ivy:settings/>
		<ivy:retrieve pattern="${libraries.dir}/[organisation]/[module]/[artifact].[ext]" />
	</target>

	<target name="build" depends="clean, retrieve">
		<antcall target="build-${module.type}" />
	</target>

	<target name="transform-assemlbyinfo">
		<!--
		
		[assembly: AssemblyVersion("1.0.0.0")]
		[assembly: AssemblyFileVersion("1.0.0.0")]

		-->
		<replace file="Properties\AssemblyInfo.cs">
			<replacefilter token="1.0.0.0" value="${module.version}.0"/>
		</replace>
	</target>

	<target name="build-dotnet" depends="transform-assemlbyinfo">
		<exec executable="C:\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe" failonerror="true">
			<arg value="/t:rebuild" />
			<arg value="/ignoreprojectextensions:.sln" />
			<arg value="/property:OutputPath=${output.dir}\" />
		</exec>
	</target>

	<target name="package" depends="build">
	</target>

	<target name="publish" depends="package">
	
		<condition property="module.revision" value="9.9.9">
			<isset property="is.local"/>
		</condition>		
	
		<echo message="module.revision = ${module.revision}" />		
		
		<property name="module.revision" value="${module.version}" />
		
		<echo message="module.revision = ${module.revision}" />		
			
		<property name="ivy.resolver" value="local" />
		<property name="ivy.status" value="integration" />

		<ivy:buildnumber organisation="${ivy.organisation}" module="${ivy.module}" revision="${module.revision}" branch="${branch.name}" resolver="${ivy.resolver}" />

		<property name="new.revision" value="${ivy.new.revision}" />
		
		<echo message="new.revision = ${new.revision}" />
	
		<ivy:publish resolver="${ivy.resolver}" pubrevision="${new.revision}" forcedeliver="true" pubbranch="${branch.name}">
			<artifacts pattern="${output.dir}/[artifact].[ext]" />
		</ivy:publish>
	</target>

	<target name="publish-local">
		<property name="is.local" value="true" />

		<antcall target="publish" />
	</target>

	<target name="publish-release">
		<antcall target="publish" />
	</target>
</project>